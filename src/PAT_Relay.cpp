#include <Arduino.h>
#include "PAT_Relay.h"
#include "PAT_Task_MCU.h"
#include "PAT_JSON.h"

//////////////////////////////////////////////////////////////////////////Fix Config////////////////////////////////////////////////////////////////////////////////////
const uint8_t _RELAY1_PIN = 4;
const uint8_t _RELAY2_PIN = 2;
const uint8_t _RELAY3_PIN = 15;
const uint8_t _RELAY4_PIN = 13;
const uint8_t _RELAY1_ACTIVE_MODE = HIGH;
const uint8_t _RELAY2_ACTIVE_MODE = HIGH;
const uint8_t _RELAY3_ACTIVE_MODE = HIGH;
const uint8_t _RELAY4_ACTIVE_MODE = HIGH;
////////////////////////////////////////////////////////////////////////Class Definitions//////////////////////////////////////////////////////////////////////////////////////
class_Relay relay[] = {  //relayObjects
    class_Relay(_RELAY1_PIN, _RELAY1_ACTIVE_MODE),
    class_Relay(_RELAY2_PIN, _RELAY2_ACTIVE_MODE),
    class_Relay(_RELAY3_PIN, _RELAY3_ACTIVE_MODE),
    class_Relay(_RELAY4_PIN, _RELAY4_ACTIVE_MODE)
};
//class_Array<_RELAYS_FIRST_INDEX, _RELAYS_LAST_INDEX, class_Relay> relay(relayObjects);
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//class_Array<1, 4, class_Relay, uint8_t, bool> RelayArray(Relay1_PIN, true),RelayArray(Relay2_PIN, true),RelayArray(Relay3_PIN, true),RelayArray(Relay4_PIN, true);


//class_Relay RelayArray[] = {relay1, relay2, relay3, relay4};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
extern class_MCU MCU; // Use the UART2
extern class_Composer compose;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void task_Relay(void) { 


  MCU.println(compose.action_relay(compose.relayData[4], compose.relayData[5], compose.relayData[6], compose.relayData[7], compose.relayData[8], compose.relayData[9], compose.relayData[10], compose.relayData[11]));
  MCU.flush();
  
  relay[0](compose.relayData[0]);
  relay[1](compose.relayData[1]);
  relay[2](compose.relayData[2]);
  relay[3](compose.relayData[3]);

  /*
    int relaydata[8] = { 0, 1, 0, 1, 0, 1, 0, 1 };
    MCU.println(compose.action_relay(relaydata, 0));
    MCU.flush();
    vTaskDelay(2000 / portTICK_PERIOD_MS);
    int relaydata2[] = {1, 0, 1, 0, 1, 0, 1, 0};
    MCU.println(compose.action_relay(relaydata2, 0));
    Serial.println(compose.action_relay(relaydata2, 0));
    MCU.flush();
    vTaskDelay(2000 / portTICK_PERIOD_MS);
    */
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



float mapFloat(float value, float inMin, float inMax, float outMin, float outMax) {
  return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class_Relay::class_Relay(uint8_t pin, bool activeMode)
  : pin(pin), mode(activeMode){
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void class_Relay::operator()(bool activeMode) {
(activeMode == mode) ? turnOn() : turnOff();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void class_Relay::init() {
  pinMode(pin, OUTPUT);
  turnOff();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void class_Relay::turnOn() {
  digitalWrite(pin, mode);
  this->isOn = mode;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void class_Relay::turnOff() {
  digitalWrite(pin, !mode);
  isOn = !mode;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
bool class_Relay::getState() {
  return isOn;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void class_Relay::toggle() {
  (isOn==mode) ? this->turnOff() : this->turnOn();
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

